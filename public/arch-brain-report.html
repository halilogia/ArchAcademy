
<!DOCTYPE html>
<html>
<head>
    <title>ArchBrain Neural Report</title>
    <style>
        body { margin: 0; background: #020617; color: white; font-family: sans-serif; overflow: hidden; }
        #info { position: absolute; top: 25px; left: 25px; z-index: 100; pointer-events: none; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .badge { background: #3b82f6; color: white; padding: 4px 12px; border-radius: 4px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        h1 { margin: 10px 0 0 0; font-size: 28px; }
        #stats { opacity: 0.7; font-size: 14px; margin-top: 5px; }

        /* Premium Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 0px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

        #search-results {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            margin-top: 5px;
            max-height: 250px;
            overflow-y: auto;
            overflow-x: hidden;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            box-sizing: border-box;
        }

        .result-item {
            padding: 12px;
            cursor: pointer;
            font-size: 13px;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            box-sizing: border-box;
        }
        .result-item:hover { background: rgba(59, 130, 246, 0.15); }
        .result-item b { display: block; overflow: hidden; text-overflow: ellipsis; }
        .result-item small { opacity: 0.6; display: block; overflow: hidden; text-overflow: ellipsis; }
    </style>
    <!-- Using latest version to fix Three.js warnings -->
    <script src="https://unpkg.com/3d-force-graph"></script>
</head>
<body>
    <div id="search-container" style="position: absolute; top: 20px; left: 20px; z-index: 1000; width: 260px;">
        <input type="text" id="search-input" 
               placeholder="Search file..." 
               autocomplete="off" 
               spellcheck="false"
               style="width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(15, 23, 42, 0.9); color: white; outline: none; transition: border-color 0.2s;">
        <div id="search-results"></div>
    </div>

    <div id="details-panel" style="position: absolute; top: 0; right: -300px; width: 300px; height: 100%; background: rgba(2, 6, 23, 0.95); border-left: 1px solid #1e293b; padding: 20px; box-sizing: border-box; transition: right 0.3s ease; overflow-y: auto; z-index: 1000;">
        <h2 id="panel-title" style="margin-top: 0; font-size: 18px; color: #38bdf8; word-break: break-all;">No Selection</h2>
        <div id="panel-content"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const colorMap = {
                'Domain': '#ef4444',
                'Infra': '#10b981',
                'App': '#f59e0b',
                'Page': '#3b82f6',
                'Component': '#60a5fa',
                'Hook': '#a855f7',
                'State': '#ec4899',
                'Other': '#64748b'
            };

            let highlightNodes = new Set();
            let highlightLinks = new Set();
            let selectedNode = null;
            let graphData = null;

            // Fetch the generated JSON data with cache busting
            fetch('./project-graph.json?t=' + new Date().getTime())
                .then(res => res.json())
                .then(gData => {
                    graphData = gData;
                    // Safety check
                    const container = document.getElementById('3d-graph');
                    if (!container) {
                        const newContainer = document.createElement('div');
                        newContainer.id = '3d-graph';
                        newContainer.style.cssText = "width:100%; height:100%; position:absolute; top:0; left:0;";
                        document.body.prepend(newContainer);
                    }

                    // Pre-process data
                    gData.nodes.forEach(node => {
                        node.neighbors = [];
                        node.links = [];
                    });

                    const Graph = ForceGraph3D()
                        (document.getElementById('3d-graph'))
                        .graphData(gData)
                        .nodeLabel(node => {
                            const color = colorMap[node.category] || '#fff';
                            return `<div style="padding: 8px; color: #fff; background: rgba(0,0,0,0.8); border-radius: 4px;">
                                      <strong style="color:${color}">${node.label}</strong><br/>
                                      <span style="font-size:10px; opacity:0.8">${node.category}</span>
                                    </div>`;
                        })
                        .nodeColor(node => {
                             if (selectedNode && !highlightNodes.has(node)) return 'rgba(255,255,255,0.1)';
                             return colorMap[node.category] || '#ffffff';
                         })
                        .nodeOpacity(1)
                        .linkWidth(link => highlightLinks.has(link) ? 3 : 1)
                        .linkOpacity(link => selectedNode && !highlightLinks.has(link) ? 0.05 : 0.4)
                        .nodeRelSize(7)
                        .nodeVal(node => Math.sqrt(node.size) * 0.05 + 1)
                        .backgroundColor('#020617')
                        .onNodeClick(handleNodeClick)
                        .onBackgroundClick(() => {
                            clearSelection();
                            document.getElementById('details-panel').style.right = '-300px';
                        });

                    function handleNodeClick(node) {
                        if (!node) return;
                        selectedNode = node;
                        
                        highlightNodes.clear();
                        highlightLinks.clear();
                        highlightNodes.add(node);
                        
                        const { links } = Graph.graphData();
                        const incoming = [];
                        const outgoing = [];

                        links.forEach(link => {
                            if (link.source.id === node.id) {
                                highlightLinks.add(link);
                                highlightNodes.add(link.target);
                                outgoing.push(link.target);
                            } else if (link.target.id === node.id) {
                                highlightLinks.add(link);
                                highlightNodes.add(link.source);
                                incoming.push(link.source);
                            }
                        });

                        Graph.nodeColor(Graph.nodeColor());
                        Graph.linkWidth(Graph.linkWidth());
                        Graph.linkOpacity(Graph.linkOpacity());
                        Graph.linkDirectionalParticles(link => highlightLinks.has(link) ? 4 : 0);
                        Graph.linkDirectionalParticleSpeed(0.01);

                        // Camera focus
                        focusCamera(node);

                        // Panel Update
                        updatePanel(node, incoming, outgoing);
                    }

                    function focusCamera(node) {
                        const distance = 100;
                        const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
                        Graph.cameraPosition(
                            { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, 
                            node, 
                            2000
                        );
                    }

                    function clearSelection() {
                        selectedNode = null;
                        highlightNodes.clear();
                        highlightLinks.clear();
                        Graph.nodeColor(Graph.nodeColor());
                        Graph.linkWidth(Graph.linkWidth());
                        Graph.linkOpacity(Graph.linkOpacity());
                        Graph.linkDirectionalParticles(0);
                    }

                    function updatePanel(node, incoming, outgoing) {
                        const panel = document.getElementById('details-panel');
                        const title = document.getElementById('panel-title');
                        const content = document.getElementById('panel-content');
                        if (!panel) return;
                        
                        panel.style.right = '0';
                        title.innerText = node.label || node.id;
                        title.style.color = colorMap[node.category] || '#fff';

                        content.innerHTML = `
                            <div style="font-size: 13px; color: #94a3b8; margin-bottom: 20px;">
                                ${node.id}<br/>
                                <span class="badge" style="background:${colorMap[node.category] || '#555'}; color:white; padding:2px 6px; border-radius:4px; font-size:10px;">${node.category}</span>
                                ${(node.size / 1024).toFixed(2)} KB
                            </div>
                            <h3 style="font-size:14px; color:#fff; border-bottom:1px solid #334155; padding-bottom:5px;">Imports (${outgoing.length})</h3>
                            <ul style="list-style:none; padding:0; font-size:13px; color:#cbd5e1;">
                                ${outgoing.map(n => `<li onclick="window.focusNodeById('${n.id}')" style="cursor:pointer; margin-bottom:4px;color:${colorMap[n.category]}">→ ${n.label}</li>`).join('') || '<li>-</li>'}
                            </ul>
                            <h3 style="font-size:14px; color:#fff; border-bottom:1px solid #334155; padding-bottom:5px; margin-top:20px;">Used By (${incoming.length})</h3>
                            <ul style="list-style:none; padding:0; font-size:13px; color:#cbd5e1;">
                                ${incoming.map(n => `<li onclick="window.focusNodeById('${n.id}')" style="cursor:pointer; margin-bottom:4px;color:${colorMap[n.category]}">← ${n.label}</li>`).join('') || '<li>-</li>'}
                            </ul>
                        `;
                    }

                    // Search Implementation
                    const searchInput = document.getElementById('search-input');
                    const resultsBox = document.getElementById('search-results');

                    window.focusNodeById = (nodeId) => {
                        const node = gData.nodes.find(n => n.id === nodeId);
                        if (node) {
                            handleNodeClick(node);
                            resultsBox.style.display = 'none';
                            searchInput.value = node.label;
                        }
                    };

                    searchInput.addEventListener('input', (e) => {
                        const val = e.target.value.toLowerCase();
                        if (!val) {
                            resultsBox.style.display = 'none';
                            return;
                        }

                        const matches = gData.nodes.filter(n => 
                            n.label.toLowerCase().includes(val) || n.id.toLowerCase().includes(val)
                        ).slice(0, 10);

                        if (matches.length) {
                            resultsBox.innerHTML = matches.map(m => `
                                <div class="result-item" onclick="window.focusNodeById('${m.id}')">
                                    <b>${m.label}</b><small>${m.id}</small>
                                </div>
                            `).join('');
                            resultsBox.style.display = 'block';
                        } else {
                            resultsBox.style.display = 'none';
                        }
                    });

                    Graph.d3Force('charge').strength(-150);
                    Graph.d3Force('link').distance(80);
                })
                .catch(err => console.error("Error loading graph data:", err));
        });
    </script>
</body>
</html>